<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amber Palette - Aroma Mosaic</title>
	<link rel="manifest" href="manifest.json" />
  
  <meta name="theme-color" content="#1f2833" />
  
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="AmberPalette" />
  <link rel="apple-touch-icon" href="icon.png" />
	
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    :root { --bg: #0b0c10; --panel: #1f2833; --text: #e9ecf1; }
    body { margin: 0; padding: 16px; font-family: sans-serif; background: var(--bg); color: var(--text); }
    .wrap { max-width: 600px; margin: 0 auto; padding-bottom: 40px; } 
    
    .header-controls { display: flex; justify-content: flex-end; margin-bottom: 12px; }
    .lang-toggle { display: flex; background: #222; border-radius: 8px; overflow: hidden; border: 1px solid #444; }
    .lang-opt { padding: 6px 16px; font-size: 12px; cursor: pointer; color: #888; font-weight: bold; transition: all 0.2s; letter-spacing: 1px; }
    .lang-opt.active { background: #555; color: #fff; }
    
    #chart-container { width: 100%; aspect-ratio: 1 / 1; background: #111; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); overflow: hidden; }
    .empty-msg { text-align: center; height: 100%; display: flex; align-items: center; justify-content: center; color: #666; font-size: 14px; letter-spacing: 1px; }
    
    .tabs { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #333; }
    .tab { padding: 8px 16px; border-radius: 20px; background: #2a2a2a; color: #aaa; border: 1px solid transparent; cursor: pointer; font-size: 12px; font-weight: bold; white-space: nowrap; transition: 0.2s; }
    .tab.active { background: #444; color: #fff; }

    /* ★新規：IMG_5141.jpg風の固定パネルデザイン */
    .active-panel {
      background: #f4f4f4; /* 白系の土台 */
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 24px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    .panel-header {
      padding: 12px 20px;
      display: flex; justify-content: space-between; align-items: center;
      color: #111; transition: background 0.3s;
    }
    .panel-title-area { display: flex; flex-direction: column; }
    .panel-title-main { font-weight: 900; font-size: 18px; letter-spacing: 1px; }
    .panel-title-sub { font-size: 11px; opacity: 0.8; font-weight: bold; margin-top: 2px; }
    .panel-count { 
      background: rgba(255,255,255,0.6); padding: 6px 14px; 
      border-radius: 20px; font-size: 13px; font-weight: bold; 
    }
    .panel-body { padding: 16px; }

    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    @media (max-width: 480px){ .grid { grid-template-columns: repeat(2, 1fr); } }
    
    /* 白い土台に合わせたボタンデザイン */
    .btn { 
      padding: 10px 4px; border-radius: 12px; background: #ffffff; 
      border: 2px solid transparent; color: #333; cursor: pointer; 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
      min-height: 70px; transition: 0.1s; text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .btn:active { transform: translateY(2px); box-shadow: none; }
    .btn-main { font-size: 13px; font-weight: 800; margin-bottom: 4px; transition: 0.2s; }
    .btn-sub { font-size: 10px; color: #888; margin-bottom: 4px; transition: 0.2s; }
    .btn-dots { font-size: 11px; letter-spacing: 1px; color: #ccc; }
    .btn.selected { background: #fafafa; } /* 選ばれた時の微細な変化 */

    /* アクションボタン（Undo追加） */
    .actions { display: flex; gap: 8px; margin-top: 10px; }
    .action-btn { 
      flex: 1; padding: 14px 4px; border-radius: 8px; font-size: 13px; font-weight: bold; 
      cursor: pointer; border: none; transition: 0.2s; 
      display: flex; align-items: center; justify-content: center; gap: 6px; 
    }
    .action-btn:active { transform: translateY(2px); }
    .btn-undo { background: #444; color: #fff; }
    .btn-reset { background: #222; color: #ccc; border: 1px solid #444; }
    .btn-copy { background: #f4d03f; color: #111; flex: 1.5; } /* コピーボタンを少し広めに */

    .toast { position: fixed; bottom: -50px; left: 50%; transform: translateX(-50%); background: #4caf50; color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: bold; transition: 0.3s; z-index: 1000; pointer-events: none; }
    .toast.show { bottom: 30px; }
  </style>
</head>
<body>
  <div class="toast" id="toast">Copied to clipboard!</div>
  <div class="wrap">
    <div class="header-controls">
      <div class="lang-toggle">
        <span class="lang-opt active" id="lang-en" onclick="setLang('en')">EN</span>
        <span class="lang-opt" id="lang-jp" onclick="setLang('jp')">JP</span>
      </div>
    </div>
    
    <div id="chart-container"><div class="empty-msg" id="emptyText">Tap flavors below to build profile</div></div>
    
    <div class="tabs" id="tabContainer"></div>

    <div class="active-panel" id="activePanel">
      <div class="panel-header" id="panelHeader">
        <div class="panel-title-area">
          <div class="panel-title-main" id="panelTitleMain">SWEET</div>
          <div class="panel-title-sub" id="panelTitleSub">スイート</div>
        </div>
        <div class="panel-count" id="panelCount">0 selected</div>
      </div>
      <div class="panel-body">
        <div class="grid" id="btnGrid"></div>
      </div>
    </div>

    <div class="actions">
      <button class="action-btn btn-undo" onclick="undoData()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.6L3 13"></path></svg>
        <span id="text-undo">Undo</span>
      </button>
      <button class="action-btn btn-reset" onclick="resetData()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        <span id="text-reset">Clear</span>
      </button>
      <button class="action-btn btn-copy" onclick="copyData()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        <span id="text-copy">Copy Data</span>
      </button>
    </div>
  </div>

  <script>
    const whiskyFlavorData = {
      fruity:  [ { en: "Lemon", jp: "レモン" }, { en: "Orange", jp: "オレンジ" }, { en: "Green apple", jp: "青リンゴ" }, { en: "Red apple", jp: "赤リンゴ" }, { en: "Pear", jp: "洋梨" }, { en: "Peach", jp: "桃" }, { en: "Apricot", jp: "アプリコット" }, { en: "Cherry", jp: "チェリー" }, { en: "Banana", jp: "バナナ" }, { en: "Pineapple", jp: "パイナップル" }, { en: "Mango", jp: "マンゴー" }, { en: "Citrus peel", jp: "柑橘ピール" } ],
      floral:  [ { en: "Lavender", jp: "ラベンダー" }, { en: "Rose", jp: "ローズ" }, { en: "Violet", jp: "スミレ" }, { en: "Orange blossom", jp: "オレンジブロッサム" }, { en: "Jasmine", jp: "ジャスミン" }, { en: "Chamomile", jp: "カモミール" }, { en: "Honeysuckle", jp: "ハニーサックル" }, { en: "Lilac", jp: "ライラック" }, { en: "Geranium", jp: "ゼラニウム" }, { en: "Peony", jp: "ピオニー" }, { en: "Osmanthus", jp: "金木犀" }, { en: "Lily", jp: "ユリ" } ],
      woody:   [ { en: "Oak", jp: "オーク" }, { en: "Cedar", jp: "シダー" }, { en: "Sandalwood", jp: "白檀" }, { en: "Cinnamon", jp: "シナモン" }, { en: "Nutmeg", jp: "ナツメグ" }, { en: "Clove", jp: "クローブ" }, { en: "Tobacco", jp: "タバコ" }, { en: "Leather", jp: "レザー" }, { en: "Toasted oak", jp: "トーストオーク" }, { en: "Charred wood", jp: "チャーウッド" }, { en: "Dry timber", jp: "乾燥材" }, { en: "Resin", jp: "樹脂" } ],
      smoky:   [ { en: "Smoke", jp: "スモーク" }, { en: "Bonfire", jp: "焚き火" }, { en: "Ash", jp: "灰" }, { en: "Seaweed", jp: "海藻" }, { en: "Rocky shore", jp: "岩場" }, { en: "Damp earth", jp: "湿った土" }, { en: "Char", jp: "炭" }, { en: "Tar", jp: "タール" }, { en: "Medicinal", jp: "メディシナル" }, { en: "Disinfectant", jp: "消毒液" }, { en: "Iodine", jp: "ヨード" }, { en: "Peat smoke", jp: "ピートスモーク" } ],
      sweet:   [ { en: "Cream", jp: "クリーム" }, { en: "Honey", jp: "ハチミツ" }, { en: "Custard", jp: "カスタード" }, { en: "Vanilla", jp: "バニラ" }, { en: "Caramel", jp: "キャラメル" }, { en: "Butterscotch", jp: "バタースコッチ" }, { en: "Toffee", jp: "トフィー" }, { en: "Maple syrup", jp: "メープルシロップ" }, { en: "Brown sugar", jp: "三温糖" }, { en: "Chocolate", jp: "チョコレート" }, { en: "Marzipan", jp: "マジパン" }, { en: "Molasses", jp: "モラセス" } ],
      winey:   [ { en: "Plum", jp: "プラム" }, { en: "Red wine", jp: "赤ワイン" }, { en: "Berry jam", jp: "ベリージャム" }, { en: "Fig", jp: "イチジク" }, { en: "Raisin", jp: "レーズン" }, { en: "Prune", jp: "プルーン" }, { en: "Sherry", jp: "シェリー" }, { en: "Port", jp: "ポート" }, { en: "Oloroso", jp: "オロロソ" }, { en: "Walnut", jp: "くるみ" }, { en: "Rancio", jp: "ランシオ" }, { en: "PX", jp: "PX" } ],
      cereal:  [ { en: "Wheat", jp: "小麦" }, { en: "Green grain", jp: "未熟穀物" }, { en: "Corn", jp: "トウモロコシ" }, { en: "Malt", jp: "モルト" }, { en: "Sweet malt", jp: "甘い麦汁" }, { en: "Oatmeal", jp: "オートミール" }, { en: "Bread", jp: "パン" }, { en: "Biscuit", jp: "ビスケット" }, { en: "Yeast", jp: "酵母" }, { en: "Toast", jp: "トースト" }, { en: "Grain porridge", jp: "麦粥" }, { en: "Rye", jp: "ライ麦" } ],
      sulfury: [ { en: "Metallic", jp: "メタリック" }, { en: "Onion", jp: "玉ねぎ" }, { en: "Garlic", jp: "ニンニク" }, { en: "Boiled cabbage", jp: "茹でたキャベツ" }, { en: "Boiled egg", jp: "茹で卵" }, { en: "Rubber", jp: "ゴム" }, { en: "Struck match", jp: "擦ったマッチ" }, { en: "Gunpowder", jp: "火薬" }, { en: "Sulfur", jp: "硫黄" }, { en: "Smoke taint", jp: "スモークテイント" }, { en: "Tanned leather", jp: "鞣し革" }, { en: "Burnt rubber", jp: "焦げたゴム" } ]
    };

    const catConfig = {
      fruity: { en: "FRUITY", jp: "フルーティー", hex: "#f4d03f" },
      floral: { en: "FLORAL", jp: "フローラル",   hex: "#ff99cc" },
      woody:  { en: "WOODY",  jp: "ウッディ",     hex: "#a67c52" },
      smoky:  { en: "SMOKY",  jp: "スモーキー",   hex: "#a0a0a0" },
      sweet:  { en: "SWEET",  jp: "スイート",     hex: "#f2a154" },
      winey:  { en: "WINEY",  jp: "ワイニー",     hex: "#e63946" },
      cereal: { en: "CEREAL", jp: "シリアル",     hex: "#d4a373" },
      sulfury:{ en: "SULFURY",jp: "サルファリー", hex: "#ccff00" }
    };

    const opacityLevels = [0, 0.3, 0.5, 0.7, 0.85, 1.0];
    let selectedScores = {};
    let actionHistory = []; // ★新規：操作履歴を保存する配列
    let myChart = null;
    let currentLang = 'en'; 
    let activeCategory = 'fruity';

    function hexToRgba(hex, alpha) {
      let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function setLang(lang) {
      currentLang = lang;
      document.getElementById('lang-en').classList.toggle('active', lang === 'en');
      document.getElementById('lang-jp').classList.toggle('active', lang === 'jp');
      
      const emptyTextEl = document.getElementById('emptyText');
      if(emptyTextEl) emptyTextEl.innerText = lang === 'en' ? 'Tap flavors below to build profile' : '下のボタンをタップして香りを記録してください';
      
      document.getElementById('text-undo').innerText = lang === 'en' ? 'Undo' : '戻る';
      document.getElementById('text-reset').innerText = lang === 'en' ? 'Clear' : 'クリア';
      document.getElementById('text-copy').innerText = lang === 'en' ? 'Copy Data' : 'データをコピー';
      
      renderTabs(); renderPanel(activeCategory); updateChart();
    }

    function renderTabs() {
      const tabContainer = document.getElementById('tabContainer');
      tabContainer.innerHTML = '';
      for (const catKey in catConfig) {
        const tab = document.createElement('div');
        tab.className = `tab ${catKey === activeCategory ? 'active' : ''}`;
        tab.innerText = catConfig[catKey][currentLang];
        tab.style.borderBottom = `3px solid ${catConfig[catKey].hex}`;
        tab.onclick = () => { activeCategory = catKey; renderTabs(); renderPanel(catKey); };
        tabContainer.appendChild(tab);
      }
    }

    // ★新規：パネル全体を描画する関数
    function renderPanel(catKey) {
      const colorHex = catConfig[catKey].hex;
      
      // ヘッダーの色と文字を更新
      document.getElementById('panelHeader').style.backgroundColor = colorHex;
      document.getElementById('panelTitleMain').innerText = catConfig[catKey][currentLang];
      document.getElementById('panelTitleSub').innerText = catConfig[catKey][currentLang === 'en' ? 'jp' : 'en'];

      // 選択中の数をカウント
      let selectedCount = 0;
      whiskyFlavorData[catKey].forEach(item => {
        if ((selectedScores[`${catKey}_${item.en}`] || 0) > 0) selectedCount++;
      });
      document.getElementById('panelCount').innerText = currentLang === 'en' ? `${selectedCount} selected` : `${selectedCount} 個選択中`;

      // ボタンを描画
      const btnGrid = document.getElementById('btnGrid');
      btnGrid.innerHTML = ''; 
      
      whiskyFlavorData[catKey].forEach(item => {
        const dataId = `${catKey}_${item.en}`;
        const currentScore = selectedScores[dataId] || 0;
        const btn = document.createElement('button');
        btn.className = `btn ${currentScore > 0 ? 'selected' : ''}`;
        
        const dots = currentScore === 0 ? "〇〇〇〇〇" : "●".repeat(currentScore) + "〇".repeat(5 - currentScore);
        
        // 選ばれている時の枠線
        if (currentScore > 0) {
          btn.style.borderColor = hexToRgba(colorHex, opacityLevels[currentScore]);
        }

        const mainText = currentLang === 'en' ? item.en : item.jp;
        const subText  = currentLang === 'en' ? item.jp : item.en;
        
        btn.innerHTML = `
          <div class="btn-main" style="color:${currentScore > 0 ? colorHex : '#333'}">${mainText}</div>
          <div class="btn-sub">${subText}</div>
          <div class="btn-dots" style="color:${currentScore > 0 ? colorHex : '#ccc'}">${dots}</div>
        `;
        
        btn.onclick = () => { 
          // ★変更：タップする前の状態を履歴に保存（Undo用）
          actionHistory.push({ cat: catKey, id: dataId, score: currentScore });
          
          selectedScores[dataId] = ((selectedScores[dataId] || 0) + 1) % 6; 
          renderPanel(catKey); 
          updateChart(); 
        };
        btnGrid.appendChild(btn);
      });
    }

    // ★新規：元に戻す関数
    function undoData() {
      if (actionHistory.length === 0) return; // 履歴がなければ何もしない
      
      // 履歴から直前の操作を取り出す
      const lastAction = actionHistory.pop();
      
      // スコアを直前の状態に戻す
      selectedScores[lastAction.id] = lastAction.score;
      
      // もし別のタブを見ていたら、操作したタブに自動で移動する
      if (activeCategory !== lastAction.cat) {
        activeCategory = lastAction.cat;
        renderTabs();
      }
      
      renderPanel(activeCategory);
      updateChart();
    }

    function updateChart() {
      const chartDom = document.getElementById('chart-container');
      const chartData = [];
      let totalScore = 0;
      for (const catKey in catConfig) {
        const children = [];
        const baseColor = catConfig[catKey].hex;
        whiskyFlavorData[catKey].forEach(item => {
          const score = selectedScores[`${catKey}_${item.en}`] || 0;
          if (score > 0) {
            children.push({ name: item[currentLang], value: score, itemStyle: { color: hexToRgba(baseColor, opacityLevels[score]) } });
            totalScore += score;
          }
        });
        if (children.length > 0) chartData.push({ name: catConfig[catKey][currentLang], itemStyle: { color: baseColor }, children: children });
      }

      if (totalScore === 0) {
        if (myChart) { myChart.dispose(); myChart = null; }
        const msg = currentLang === 'en' ? 'Tap flavors below to build profile' : '下のボタンをタップして香りを記録してください';
        chartDom.innerHTML = `<div class="empty-msg" id="emptyText">${msg}</div>`;
        return;
      }

      if (!myChart) myChart = echarts.init(chartDom);
      const option = {
        toolbox: { show: true, feature: { saveAsImage: { name: 'AromaMosaic', title: currentLang === 'en' ? 'Save Image' : '画像を保存', pixelRatio: 2, background: '#111' } }, iconStyle: { borderColor: '#fff' }, right: 15, top: 15 },
        tooltip: { formatter: '{b}: Level {c}' },
        series: [{
          type: 'treemap', data: chartData, roam: false, nodeClick: false, breadcrumb: { show: false },
          itemStyle: { borderColor: '#111', borderWidth: 1, gapWidth: 0 },
          label: { show: true, formatter: '{b}', color: '#fff', fontSize: 13, fontWeight: 'bold', textShadowColor: '#000', textShadowBlur: 4 },
          upperLabel: { show: true, height: 24, color: '#fff', fontWeight: 'bold', fontSize: 11, formatter: '{b}' }
        }]
      };
      myChart.setOption(option);
    }

    function resetData() {
      if(confirm(currentLang === 'en' ? 'Clear all data?' : '入力データをすべて消去しますか？')) { 
        selectedScores = {}; 
        actionHistory = []; // リセット時は履歴も空にする
        renderPanel(activeCategory); 
        updateChart(); 
      }
    }

    function copyData() {
      const date = new Date().toISOString().split('T')[0];
      let outputText = `Date: ${date}\n`;
      let hasData = false;
      for (const catKey in catConfig) {
        const flavors = [];
        whiskyFlavorData[catKey].forEach(item => {
          const score = selectedScores[`${catKey}_${item.en}`] || 0;
          if (score > 0) { flavors.push(`${item[currentLang]}(${score})`); hasData = true; }
        });
        if (flavors.length > 0) outputText += `${catConfig[catKey][currentLang]}: ${flavors.join(', ')}\n`;
      }
      if(!hasData) return;
      navigator.clipboard.writeText(outputText).then(() => {
        const toast = document.getElementById('toast');
        toast.innerText = currentLang === 'en' ? 'Copied to clipboard!' : 'クリップボードにコピーしました！';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2500);
      });
    }

    renderTabs(); renderPanel(activeCategory);
    window.addEventListener('resize', () => { if(myChart) myChart.resize(); });
  </script>
</body>
</html>