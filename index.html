<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Aroma Experience UI - Ultimate 120</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    :root { --bg: #0b0c10; --panel: #1f2833; --text: #e9ecf1; --accent: #c5a880; }
    
    body { 
      margin: 0; font-family: sans-serif; 
      background: linear-gradient(135deg, #3a2208 0%, #170d05 40%, #0b0c10 100%); 
      background-attachment: fixed; color: var(--text); overflow-y: auto; 
    }
    
    /* チャートエリア */
    .chart-box { 
      width: 100%; aspect-ratio: 1/1; max-width: 500px; margin: 20px auto; 
      border-radius: 16px; background: rgba(255, 255, 255, 0.03); 
      backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }
    #radar-chart, #tree-chart { width: 100%; height: 100%; }

    /* モーダル (全体) */
    #aroma-modal { 
      position: fixed; inset: 0; background: rgba(11, 12, 16, 0.85); 
      backdrop-filter: blur(20px); z-index: 1000; display: none; flex-direction: column; 
    }
    #aroma-modal.active { display: flex; }

    /* ヘッダー & タブ */
    .modal-header { padding: 40px 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .header-btns { display: flex; gap: 8px; }
    
    .close-btn { 
      background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.3); 
      padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; 
    }
    .close-btn:active { background: rgba(255,255,255,0.3); }

    .tabs { display: flex; overflow-x: auto; gap: 10px; scrollbar-width: none; }
    .tab { 
      padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.05); 
      color: #888; font-size: 13px; font-weight: bold; white-space: nowrap; cursor: pointer;
    }
    .tab.active { background: #fff; color: #000; }

    /* ★ 横スワイプ＆矢印エリア ★ */
    .swipe-wrapper { position: relative; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .nav-arrow {
      position: absolute; top: 15px; 
      background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
      color: white; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%;
      width: 44px; height: 44px; font-size: 18px; cursor: pointer; z-index: 60;
      display: flex; justify-content: center; align-items: center; transition: 0.2s;
    }
    .nav-arrow:hover { background: rgba(255, 255, 255, 0.3); }
    .arrow-left { left: 15px; }
    .arrow-right { right: 15px; }

    .swipe-container { 
      flex: 1; display: flex; overflow-x: auto; scroll-snap-type: x mandatory; 
      scrollbar-width: none; scroll-behavior: smooth;
    }
    /* ページ上部のpaddingを0にして、見出しを一番上に張り付かせる */
    .swipe-page { min-width: 100vw; box-sizing: border-box; padding: 0 15px 100px; overflow-y: auto; position: relative;}

    /* ★ カテゴリ見出し（上部にピタッと固定） ★ */
    .category-title {
      position: sticky; top: 0; z-index: 50;
      background: rgba(11, 12, 16, 0.95); backdrop-filter: blur(10px);
      border-left: 4px solid var(--accent); padding: 15px 0 10px 12px; margin: 0 0 15px 0;
      font-size: 1.4rem; font-weight: bold; text-transform: uppercase;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    /* グリッドとボタン */
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .btn { 
      position: relative; overflow: hidden; border-radius: 12px; 
      background: rgba(45, 55, 70, 0.9) !important; 
      border: 1px solid rgba(255, 255, 255, 0.15); color: #fff; 
      min-height: 100px; cursor: pointer; text-align: left;
    }
    .fill-bg { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; opacity: 0.7; transition: height 0.3s; z-index: 1;}
    
    /* ボタン内レイアウト */
    .btn-content {
      position: relative; z-index: 2; height: 100%; width: 100%;
      display: flex; flex-direction: column; justify-content: space-between; 
      align-items: center; padding: 8px 5px; box-sizing: border-box;
    }

    .btn-main { font-size: 14px; font-weight: bold; text-align: center; width: 100%; transition: opacity 0.2s; text-shadow: 0 1px 3px #000; }
    .btn-sub { font-size: 9px; opacity: 0.8; text-align: center; margin-top: 2px; color: #b0b8c3; transition: opacity 0.2s; }
    
    .tag-expert {
      position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
      width: 95%; text-align: center; font-size: clamp(9px, 2.3vw, 12px); 
      line-height: 1.2; font-style: italic; color: #fff; 
      display: none; pointer-events: none; word-break: break-all;
    }

    .meta-tags { margin-top: auto; width: 100%; display: flex; justify-content: center; }
    .tag-sense { 
      font-size: 9px; background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 2px 6px; border-radius: 4px; white-space: nowrap; font-weight: bold;
    }

    /* エキスパートモード切替時の挙動 */
    body.expert-mode .btn-main, body.expert-mode .btn-sub { opacity: 0; }
    body.expert-mode .tag-expert { display: block; }

    /* FAB */
    .fab-container { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: center; z-index: 10;}
    .fab-btn { background: var(--accent); color: #000; font-weight: bold; padding: 16px 40px; border-radius: 30px; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5);}
  </style>
</head>
<body>

  <div id="base-screen">
    <div class="chart-box"><div id="tree-chart"></div></div>
    <div class="chart-box"><div id="radar-chart"></div></div>
  </div>

  <div class="fab-container"><button class="fab-btn" id="open-btn">Add Aromas</button></div>

  <div id="aroma-modal">
    <div class="modal-header">
      <div class="header-top">
        <h3 id="modal-title" style="margin: 0;">Aroma Profile</h3>
        <div class="header-btns">
          <button class="close-btn" id="lang-btn">EN/JP</button>
          <button class="close-btn" id="mode-btn">Expert</button>
          <button class="close-btn" id="close-modal">Done</button>
        </div>
      </div>
      <div class="tabs" id="modal-tabs"></div>
    </div>
    
    <div class="swipe-wrapper">
      <button class="nav-arrow arrow-left" id="prev-btn" style="display: none;">◀</button>
      <button class="nav-arrow arrow-right" id="next-btn">▶</button>
      <div class="swipe-container" id="swipe-container"></div>
    </div>
  </div>

  <script>
    const catConfig = {
      cereal:  { jp: "シリアル", en: "Cereal", hex: "#D2B48C" },
      fruity:  { jp: "フルーティー", en: "Fruity", hex: "#f4d03f" },
      floral:  { jp: "フローラル", en: "Floral", hex: "#ff99cc" },
      woody:   { jp: "ウッディ", en: "Woody", hex: "#8B4513" },
      smoky:   { jp: "スモーキー", en: "Smoky", hex: "#708090" },
      sweet:   { jp: "スイート", en: "Sweet", hex: "#f2a154" },
      winey:   { jp: "ワイニー", en: "Winey", hex: "#B22222" },
      sulfury: { jp: "サルファリー", en: "Sulfury", hex: "#ccff00" }
    };

    const flavorData = {
      cereal: [
        { en: "Red Bean Paste", jp: "あんこ", key: "ヘキサナール｜茹で小豆｜Red Bean" },
        { en: "Oatmeal", jp: "オートミール", key: "2-アセチルピロリジン｜麦粥｜Porridge" },
        { en: "Corn", jp: "トウモロコシ", key: "ジメチルスルフィド｜茹でキビ｜Popcorn" },
        { en: "Toast", jp: "トースト", key: "2-フルフラール｜焼目｜Burnt Edge" },
        { en: "Bread", jp: "パン", key: "5-メチルフルフラール｜焼きたて｜Fresh Bake" },
        { en: "Biscuit", jp: "ビスケット", key: "2-アセチルピロリジン｜クッキー｜Cookie" },
        { en: "Popcorn", jp: "ポップコーン", key: "2-アセチル-1-ピロリン｜ポップコーン｜Movie Theater" },
        { en: "Malt", jp: "モルト", key: "マルトール｜麦チョコ｜Horlicks" },
        { en: "Rye", jp: "ライ麦", key: "4-ビニルグアイアコール｜黒パン｜Rye Bread" },
        { en: "Sweet Wort", jp: "甘い麦汁", key: "マルトース｜仕込み水｜Mashing" },
        { en: "Yeast", jp: "酵母", key: "イソアミルアルコール｜パン生地｜Sourdough" },
        { en: "Koji", jp: "麹", key: "フェネチルアルコール｜生米｜Koji/Rice Malt" },
        { en: "Wheat", jp: "小麦", key: "3-メチルブタナール｜小麦粉｜Flour" },
        { en: "Porridge", jp: "麦粥", key: "シス-3-ヘキセナール｜お粥｜Gruel" },
        { en: "Unripe Grain", jp: "未熟穀物", key: "未熟穀物成分｜若麦｜Green Malt" }
      ],
      fruity: [
        { en: "Apricot", jp: "アプリコット", key: "γ-オクタラクトン｜杏子｜Jammy" },
        { en: "Strawberry", jp: "イチゴ", key: "フラネオール｜かき氷シロップ｜Strawberries" },
        { en: "Orange", jp: "オレンジ", key: "シトラール｜蜜柑｜Marmalade" },
        { en: "Grapefruit", jp: "グレープフルーツ", key: "ヌートカトン｜苦い果皮｜Bitter Zest" },
        { en: "Cherry", jp: "チェリー", key: "ベンズアルデヒド｜さくらんぼ｜Maraschino" },
        { en: "Pineapple", jp: "パイナップル", key: "エチルブチレート｜パイナップル｜Tropical" },
        { en: "Banana", jp: "バナナ", key: "酢酸イソアミル｜チョコバナナ｜Banana Bread" },
        { en: "Mango", jp: "マンゴー", key: "ミルセン｜完熟｜Exotic" },
        { en: "Melon", jp: "メロン", key: "(Z)-6-ノネナール｜完熟の網目｜Honeydew" },
        { en: "Lemon", jp: "レモン", key: "リモネン｜レモン｜Zest" },
        { en: "Citrus Peel", jp: "柑橘ピール", key: "シトラスオイル｜柑橘ピール｜Grated Peel" },
        { en: "Green Apple", jp: "青リンゴ", key: "ヘキシルアセテート｜青リンゴ｜Granny Smith" },
        { en: "Red Apple", jp: "赤リンゴ", key: "エチル-2-メチルブチレート｜蜜入り｜Juicy" },
        { en: "Peach", jp: "桃", key: "γ-ウンデカラクトン｜白桃｜Syrup" },
        { en: "Pear", jp: "洋梨", key: "エチルデカノエート｜ラ・フランス｜Poached Pear" }
      ],
      floral: [
        { en: "Elderflower", jp: "エルダーフラワー", key: "ホットリエノール｜エルダーフラワー｜Syrupy" },
        { en: "Orange Blossom", jp: "オレンジブロッサム", key: "ネロール｜柑橘花｜Neroli" },
        { en: "Chamomile", jp: "カモミール", key: "α-ビサボロール｜花茶｜Herbal Tea" },
        { en: "Jasmine", jp: "ジャスミン", key: "インドール｜茉莉花｜Heady Floral" },
        { en: "Violet", jp: "スミレ", key: "β-イオノン｜スミレ｜Face Powder" },
        { en: "Geranium", jp: "ゼラニウム", key: "ゲラニオール｜葉花｜Rosemary-like" },
        { en: "Honeysuckle", jp: "ハニーサックル", key: "ベンジルアセテート｜ハニーサックル｜Nectar" },
        { en: "Peony", jp: "ピオニー", key: "シトロネロール｜牡丹｜Full Bloom" },
        { en: "Lily", jp: "ユリ", key: "ベンジルアルコール｜清楚な花｜Purity" },
        { en: "Lilac", jp: "ライラック", key: "リラール｜春の花｜Soap-like" },
        { en: "Lavender", jp: "ラベンダー", key: "リナロール｜ポプリ｜Relaxation" },
        { en: "Rose", jp: "ローズ", key: "フェニルエタノール｜薔薇｜Turkish Delight" },
        { en: "Rosemary", jp: "ローズマリー", key: "1,8-シネオール｜ハーブの枝｜Fresh Herbal" },
        { en: "Osmanthus", jp: "金木犀", key: "γ-デカラクトン｜金木犀｜Apricot-like" },
        { en: "Daphne", jp: "沈丁花", key: "アニスアルデヒド｜沈丁花｜Daphne" }
      ],
      woody: [
        { en: "Oak", jp: "オーク", key: "オークラクトン｜新しい家具｜Sawdust" },
        { en: "Clove", jp: "クローブ", key: "オイゲノール｜歯医者さん｜Mulled Wine" },
        { en: "Coffee", jp: "コーヒー", key: "フルフリルチオール｜焙煎豆｜Roasted Bean" },
        { en: "Coconut", jp: "ココナッツ", key: "オークラクトン｜日焼け止め｜Pina Colada" },
        { en: "Cedar", jp: "シダー", key: "セドロール｜鉛筆｜Cigar Box" },
        { en: "Cinnamon", jp: "シナモン", key: "シンナムアルデヒド｜八ツ橋｜Apple Pie" },
        { en: "Tobacco", jp: "タバコ", key: "β-ダマセノン｜シガー｜Hand-rolled" },
        { en: "Charred Wood", jp: "チャーウッド", key: "フェノール縮合体｜炭木｜Burned Log" },
        { en: "Toasted Oak", jp: "トーストオーク", key: "バニリン｜焼樽｜Fresh Toasting" },
        { en: "Nutmeg", jp: "ナツメグ", key: "ミリスチシン｜ハンバーグ｜Eggnog" },
        { en: "Leather", jp: "レザー", key: "イソブチルキノリン｜古本屋｜Old Saddle" },
        { en: "Roasted Meat", jp: "ロースト肉", key: "メチオナール｜肉汁｜Gravy" },
        { en: "Kiln-Dried Wood", jp: "乾燥材", key: "乾燥木材成分｜古材｜Antique Barn" },
        { en: "Resin", jp: "樹脂", key: "α-ピネン｜松脂｜Pine Sap" },
        { en: "Sandalwood", jp: "白檀", key: "サンタロール｜お香｜Incense" }
      ],
      smoky: [
        { en: "Smoke", jp: "スモーク", key: "燃焼揮発物｜薫製｜BBQ Smoke" },
        { en: "Tar", jp: "タール", key: "クレオソート｜舗装路｜Asphalt" },
        { en: "Barbecue", jp: "バーベキュー", key: "シリンガール｜網焼きの煙｜Backyard BBQ" },
        { en: "Peat Smoke", jp: "ピートスモーク", key: "フェノール｜泥炭｜Bog" },
        { en: "Medicinal", jp: "メディシナル", key: "クレゾール｜正露丸｜First-aid" },
        { en: "Iodine", jp: "ヨード", key: "ヨードフェノール｜海薬｜Seaweed Medicine" },
        { en: "Seaweed", jp: "海藻", key: "ジメチルスルフィド｜海藻｜Kelp" },
        { en: "Ash", jp: "灰", key: "無機灰成分｜灰皿｜Cold Ash" },
        { en: "Rocky Shore", jp: "岩場", key: "潮風成分｜潮風｜Ocean Spray" },
        { en: "Damp Earth", jp: "湿った土", key: "ジオスミン｜雨上がり｜Petrichor" },
        { en: "Extinguished", jp: "消し炭", key: "炭酸塩｜たき火のあと｜Extinguished" },
        { en: "Disinfectant", jp: "消毒液", key: "ヨウ素揮発物｜病院｜TCP" },
        { en: "Charcoal", jp: "炭", key: "フェノール縮合体｜黒焦げ｜Soot" },
        { en: "Bonfire", jp: "焚き火", key: "グアイアコール｜薪煙｜Camping" },
        { en: "Smoked Meat", jp: "燻製肉", key: "4-メチルグアイアコール｜厚切りベーコン｜Smoked Ham" }
      ],
      sweet: [
        { en: "Almond", jp: "アーモンド", key: "ベンズアルデヒド誘導体｜杏仁豆腐｜Amaretto" },
        { en: "Custard", jp: "カスタード", key: "エチルバニリン｜プリン｜Creme Brulee" },
        { en: "Caramel", jp: "キャラメル", key: "5-HMF｜生キャラメル｜Toffee Apple" },
        { en: "Cream", jp: "クリーム", key: "δ-デカラクトン｜生クリーム｜Whipped Cream" },
        { en: "Chocolate", jp: "チョコレート", key: "ピラジン類｜カカオ｜Dark Cocoa" },
        { en: "Toffee", jp: "トフィー", key: "マルトール｜鼈甲飴｜Hard Toffee" },
        { en: "Butter", jp: "バター", key: "2,3-ブタンジオン｜有塩バター｜Rich Butter" },
        { en: "Butterscotch", jp: "バタースコッチ", key: "ジアセチル｜バター飴｜Werther's" },
        { en: "Honey", jp: "ハチミツ", key: "フェニル酢酸｜レンゲ蜜｜Manuka Honey" },
        { en: "Vanilla", jp: "バニラ", key: "バニリン｜バニラ｜Custard" },
        { en: "Marzipan", jp: "マジパン", key: "ベンズアルデヒド｜杏仁｜Almond Paste" },
        { en: "Maple Syrup", jp: "メープルシロップ", key: "ソトロン｜ホットケーキ｜Pancake" },
        { en: "Molasses", jp: "モラセス", key: "フルフリルアルコール｜黒蜜｜Treacle" },
        { en: "Muscovado Sugar", jp: "黒糖", key: "糖分解複合体｜かりんとう｜Molasses" },
        { en: "Brown Sugar", jp: "三温糖", key: "メラノイジン｜黒砂糖｜Muscovado" }
      ],
      winey: [
        { en: "PX", jp: "PX", key: "フェノール縮合物｜極甘口｜Syrup-like" },
        { en: "Fig", jp: "イチジク", key: "フィグラクトン｜無花果｜Fig Roll" },
        { en: "Oloroso", jp: "オロロソ", key: "アセトアルデヒド｜酸化熟成｜Old Solera" },
        { en: "Walnut", jp: "くるみ", key: "ジャグロン｜殻｜Nut shells" },
        { en: "Sherry", jp: "シェリー", key: "アセタール類｜干し柿｜Fruitcake" },
        { en: "Nut Shell", jp: "ナッツの殻", key: "タンニン酸化物｜渋皮｜Nutty Shell" },
        { en: "Plum", jp: "プラム", key: "γ-ノナラクトン｜李｜Prune juice" },
        { en: "Prune", jp: "プルーン", key: "ベンズアルデヒド酸化体｜ドライフルーツ｜Sticky Date" },
        { en: "Berry Jam", jp: "ベリージャム", key: "HMF｜コンポート｜Preserves" },
        { en: "Port", jp: "ポート", key: "ソトロン｜酒精｜Vintage Port" },
        { en: "Rancio", jp: "ランシオ", key: "ソトロン酸化体｜古酒｜Aged Cognac" },
        { en: "Raisin", jp: "レーズン", key: "フルフラール｜干し葡萄｜Sun-dried" },
        { en: "Old Bookshop", jp: "古本屋", key: "リグニン分解物｜古書｜Old Library" },
        { en: "Ripe Grape", jp: "熟した葡萄", key: "リナロール酸化体｜醸造所｜Winery" },
        { en: "Red Wine", jp: "赤ワイン", key: "4-エチルフェノール｜葡萄園｜Vineyard" }
      ],
      sulfury: [
        { en: "Rubber", jp: "ゴム", key: "チオール類｜タイヤ｜New Tires" },
        { en: "Smoky Taint", jp: "スモークテイント", key: "硫黄酸化物｜焦げ臭｜Sulfury Smoke" },
        { en: "Chalk", jp: "チョーク", key: "炭酸カルシウム粉塵｜チョーク｜Chalky" },
        { en: "Garlic", jp: "ニンニク", key: "アリシン｜ニンニク｜Roasted Garlic" },
        { en: "Metallic", jp: "メタリック", key: "鉄イオン由来臭｜十円玉｜Coins" },
        { en: "Roast Beef", jp: "ローストビーフ", key: "2-Methyl-3-furanthiol｜肉汁｜Gravy" },
        { en: "Gunpowder", jp: "火薬", key: "硝酸エステル分解物｜火打ち石｜Flint" },
        { en: "Onion", jp: "玉ねぎ", key: "プロパンチオール｜炒め玉ねぎ｜Fried Onion" },
        { en: "Struck Match", jp: "擦ったマッチ", key: "二酸化硫黄｜花火の煙｜Struck Match" },
        { en: "Burnt Rubber", jp: "焦げたゴム", key: "イソプレン酸化物｜急ブレーキ｜Skid Marks" },
        { en: "Wet Stone", jp: "濡れた石", key: "ミネラル揮発物｜川原｜Wet Stone" },
        { en: "Sulfur", jp: "硫黄", key: "硫化水素｜温泉地｜Matchstick" },
        { en: "Boiled Cabbage", jp: "茹でたキャベツ", key: "ジメチルトリスルフィド｜茹でたキャベツ｜Veggie Water" },
        { en: "Boiled Egg", jp: "茹で卵", key: "メチルメルカプタン｜硫黄泉｜Hot Springs" },
        { en: "Tanned Leather", jp: "鞣し革", key: "硫黄鞣し成分｜硫革｜Saddle" }
      ]
    };

    let selectedScores = {};
    let radarChart, treeChart;
    let currentLang = 'ja';

    // UI初期化
    function initUI() {
      const tabsDiv = document.getElementById('modal-tabs');
      const swipeDiv = document.getElementById('swipe-container');
      const categories = Object.keys(catConfig);

      swipeDiv.innerHTML = ''; tabsDiv.innerHTML = '';

      categories.forEach((catKey, index) => {
        // --- タブ生成 ---
        const tab = document.createElement('div');
        tab.className = `tab ${index === 0 ? 'active' : ''}`;
        tab.innerText = (currentLang === 'ja') ? catConfig[catKey].jp : catConfig[catKey].en;
        tab.onclick = () => swipeDiv.scrollTo({ left: index * window.innerWidth, behavior: 'smooth' });
        tabsDiv.appendChild(tab);

        // --- ページ生成 ---
        const page = document.createElement('div');
        page.className = 'swipe-page';
        
        // ★ 見出し（スクロールで上にピタッと張り付く！）
        const title = document.createElement('div');
        title.className = 'category-title';
        title.style.borderColor = catConfig[catKey].hex;
        title.style.color = catConfig[catKey].hex;
        title.innerText = (currentLang === 'ja') ? catConfig[catKey].jp : catConfig[catKey].en;
        page.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'grid';

        // --- ボタン生成 ---
        flavorData[catKey].forEach(item => {
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.style.borderColor = catConfig[catKey].hex + "66";

          const [expert, senseJP, senseEN] = item.key.split('｜');
          const senseBadge = (currentLang === 'ja') ? senseJP : senseEN;
          const displayName = (currentLang === 'ja') ? item.jp : item.en;
          const displaySub = (currentLang === 'ja') ? item.en : item.jp;

          btn.innerHTML = `
            <div class="fill-bg" style="background-color: ${catConfig[catKey].hex}"></div>
            <div class="btn-content">
              <div class="btn-main">${displayName}</div>
              <div class="btn-sub">${displaySub}</div>
              <div class="tag-expert">${expert}</div>
              <div class="meta-tags">
                <span class="tag-sense">${senseBadge}</span>
              </div>
            </div>
          `;
          
          const id = `${catKey}_${item.en}`;
          if (selectedScores[id]) btn.querySelector('.fill-bg').style.height = `${selectedScores[id] * 20}%`;

          btn.onclick = () => {
            selectedScores[id] = ((selectedScores[id] || 0) + 1) % 6;
            btn.querySelector('.fill-bg').style.height = `${selectedScores[id] * 20}%`;
            updateCharts();
          };
          grid.appendChild(btn);
        });
        page.appendChild(grid);
        swipeDiv.appendChild(page);
      });

      // --- スワイプと矢印の連動 ---
      const totalPages = categories.length;
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');

      if (prevBtn) prevBtn.style.display = 'none';

      swipeDiv.onscroll = () => {
        const idx = Math.round(swipeDiv.scrollLeft / window.innerWidth);
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        if (prevBtn) prevBtn.style.display = idx === 0 ? 'none' : 'flex';
        if (nextBtn) nextBtn.style.display = idx === totalPages - 1 ? 'none' : 'flex';
      };

      if (prevBtn) {
        prevBtn.onclick = () => {
          const idx = Math.round(swipeDiv.scrollLeft / window.innerWidth);
          if (idx > 0) swipeDiv.scrollTo({ left: (idx - 1) * window.innerWidth, behavior: 'smooth' });
        };
      }
      
      if (nextBtn) {
        nextBtn.onclick = () => {
          const idx = Math.round(swipeDiv.scrollLeft / window.innerWidth);
          if (idx < totalPages - 1) swipeDiv.scrollTo({ left: (idx + 1) * window.innerWidth, behavior: 'smooth' });
        };
      }
    }

    // チャート更新
    function updateCharts() {
      const radarValues = [];
      const indicator = [];
      const treeData = [];

      Object.keys(catConfig).forEach(cat => {
        let total = 0;
        let children = [];
        flavorData[cat].forEach(item => {
          const score = selectedScores[cat + "_" + item.en] || 0;
          if (score > 0) {
            total += score;
            children.push({ name: (currentLang === 'ja' ? item.jp : item.en), value: score, itemStyle: { color: catConfig[cat].hex } });
          }
        });
        indicator.push({ name: (currentLang === 'ja' ? catConfig[cat].jp : catConfig[cat].en), max: 30 });
        radarValues.push(total);
        if (children.length > 0) treeData.push({ name: catConfig[cat].jp, children });
      });

      radarChart.setOption({
        radar: { indicator, axisName: { color: '#ccc' } },
        series: [{ type: 'radar', data: [{ value: radarValues, areaStyle: { opacity: 0.4, color: '#c5a880' } }] }]
      });
      treeChart.setOption({ series: [{ type: 'treemap', data: treeData, breadcrumb: { show: false } }] });
    }

    // イベントリスナー
    document.getElementById('open-btn').onclick = () => document.getElementById('aroma-modal').classList.add('active');
    document.getElementById('close-modal').onclick = () => document.getElementById('aroma-modal').classList.remove('active');
    document.getElementById('mode-btn').onclick = () => document.body.classList.toggle('expert-mode');
    document.getElementById('lang-btn').onclick = () => {
      currentLang = (currentLang === 'ja') ? 'en' : 'ja';
      initUI();
      updateCharts();
    };

    window.onload = () => {
      radarChart = echarts.init(document.getElementById('radar-chart'));
      treeChart = echarts.init(document.getElementById('tree-chart'));
      initUI(); 
      updateCharts();
    };
  </script>
</body>
</html>