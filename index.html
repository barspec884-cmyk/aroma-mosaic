<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Amber Palette - Aroma Mosaic</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  
  <style>
    :root { 
      --bg: #0b0c10; 
      --panel: #1f2833; 
      --text: #e9ecf1; 
      --card-bg: #ffffff;
      --card-text: #333333;
    }
    body { margin: 0; padding: 16px; font-family: sans-serif; background: var(--bg); color: var(--text); padding-bottom: 120px; }
    .wrap { max-width: 600px; margin: 0 auto; } 

    /* ▼ チャートエリア ▼ */
    .chart-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1;
      margin-bottom: 12px; 
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      background: #000;
      overflow: hidden;
      border: 1px solid #222;
    }
    #chart-container { width: 100%; height: 100%; }

    .empty-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; display: flex; align-items: center; justify-content: center;
      color: #666; font-size: 14px; letter-spacing: 1px; z-index: 50;
    }

    /* ▼ コントロールボタン列 ▼ */
    .controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 0 2px;
    }

    .lang-toggle { 
      display: flex; background: #1a1a1a; border-radius: 6px; 
      overflow: hidden; border: 1px solid #444; 
    }
    .lang-opt { padding: 8px 20px; font-size: 13px; cursor: pointer; color: #888; font-weight: bold; transition: 0.2s; letter-spacing: 1px; }
    .lang-opt.active { background: #555; color: #fff; }

    .chart-dl-btn {
      background: #1a1a1a; color: #ccc; border: 1px solid #444; 
      cursor: pointer; display: flex; align-items: center; justify-content: center; 
      padding: 8px 12px; border-radius: 6px; transition: 0.2s;
    }
    .chart-dl-btn:hover { color: #fff; background: #333; }
    .chart-dl-btn .material-symbols-rounded { font-size: 20px; }

    /* ▼ タブエリア ▼ */
    .tabs-wrapper {
      display: flex;
      width: 100%;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      position: relative;
    }
    .tab-nav-btn {
      flex-shrink: 0; 
      background: #2a2a2a; border: 1px solid #444; color: #aaa; border-radius: 50%;
      width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.2s;
    }
    .tab-nav-btn:active { background: #555; color: #fff; }
    .tab-nav-btn .material-symbols-rounded { font-size: 20px; }

    .tabs { 
      flex: 1; min-width: 0; display: flex; overflow-x: auto; gap: 8px; padding-bottom: 4px; 
      scrollbar-width: none; scroll-behavior: smooth;
    }
    .tabs::-webkit-scrollbar { display: none; }
    
    .tab { 
      padding: 8px 16px; border-radius: 20px; background: #2a2a2a; color: #888; 
      cursor: pointer; font-size: 12px; font-weight: bold; white-space: nowrap; 
      transition: 0.2s; border: 1px solid transparent; flex-shrink: 0;
    }
    .tab.active { background: #444; color: #fff; border-color: #666; }

    /* ▼ ヘッダー・グリッド・フッター ▼ */
    .category-header {
      background: #444; color: #111; padding: 16px 20px; border-radius: 12px 12px 0 0;
      display: flex; justify-content: space-between; align-items: center; margin-top: 10px; transition: background 0.3s;
    }
    .cat-title h2 { margin: 0; font-size: 20px; font-weight: 800; text-transform: uppercase; }
    .cat-title span { font-size: 11px; font-weight: bold; opacity: 0.8; display: block; margin-top: 2px; }
    .cat-count { background: rgba(255,255,255,0.3); padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: bold; }

    .grid-bg { background: #f0f2f5; border-radius: 0 0 12px 12px; padding: 16px; margin-bottom: 24px; min-height: 200px; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    @media (max-width: 550px){ .grid { grid-template-columns: repeat(2, 1fr); } }

    .card-btn {
      background: var(--card-bg); border-radius: 12px; padding: 14px 4px; text-align: center; cursor: pointer;
      transition: all 0.15s ease; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center;
      user-select: none; -webkit-tap-highlight-color: transparent;
    }
    .card-btn:active { transform: scale(0.96); }
    .card-btn.selected { background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .card-main { font-size: 14px; font-weight: 800; color: var(--card-text); margin-bottom: 4px; line-height: 1.2; }
    .card-sub { font-size: 10px; color: #999; margin-bottom: 6px; font-weight: bold; }
    .card-dots { font-size: 12px; color: #ddd; letter-spacing: 2px; line-height: 1; }

    .action-bar { display: flex; gap: 12px; margin-top: 20px; }
    .action-btn { flex: 1; height: 48px; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
    .action-btn:active { transform: translateY(2px); }
    .btn-dark { background: #333; color: #fff; border: 1px solid #444; }
    .btn-primary { background: #f4d03f; color: #111; }
    .material-symbols-rounded { font-size: 18px; }

    .toast { position: fixed; bottom: -60px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: bold; transition: 0.3s; z-index: 2000; box-shadow: 0 10px 20px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px; }
    .toast.show { bottom: 30px; }
  </style>
</head>
<body>
  <div class="toast" id="toast">
    <span class="material-symbols-rounded">check_circle</span>
    <span id="toast-msg">Copied!</span>
  </div>

  <div class="wrap">
    
    <div class="chart-wrapper">
      <div class="empty-overlay" id="emptyText">Tap flavors below to build profile</div>
      <div id="chart-container"></div>
    </div>

    <div class="controls-row">
      <div class="lang-toggle">
        <span class="lang-opt active" id="lang-en" onclick="setLang('en')">EN</span>
        <span class="lang-opt" id="lang-jp" onclick="setLang('jp')">JP</span>
      </div>
      <button class="chart-dl-btn" onclick="saveImage()" title="Save Image">
        <span class="material-symbols-rounded">download</span>
      </button>
    </div>

    <div class="tabs-wrapper">
      <button class="tab-nav-btn" onclick="scrollTabs('left')">
        <span class="material-symbols-rounded">chevron_left</span>
      </button>
      <div class="tabs" id="tabContainer"></div>
      <button class="tab-nav-btn" onclick="scrollTabs('right')">
        <span class="material-symbols-rounded">chevron_right</span>
      </button>
    </div>

    <div class="category-header" id="catHeader">
      <div class="cat-title">
        <h2 id="header-main">FRUITY</h2>
        <span id="header-sub">フルーティー</span>
      </div>
      <div class="cat-count" id="header-count">0 selected</div>
    </div>

    <div class="grid-bg">
      <div class="grid" id="btnGrid"></div>
    </div>
    
    <div class="action-bar">
      <button class="action-btn btn-dark" onclick="undo()" id="undoBtn" style="opacity:0.5; pointer-events:none;">
        <span class="material-symbols-rounded">undo</span>
        <span id="text-undo">Undo</span>
      </button>
      <button class="action-btn btn-dark" onclick="resetData()">
        <span class="material-symbols-rounded">delete</span>
        <span id="text-clear">Clear</span>
      </button>
      <button class="action-btn btn-primary" onclick="copyData()" id="copyBtn">
        <span class="material-symbols-rounded">content_copy</span>
        <span id="text-copy">Copy Data</span>
      </button>
    </div>
  </div>

  <script>
    const whiskyFlavorData = {
      fruity:  [ { en: "Citrus peel", jp: "柑橘ピール" }, { en: "Lemon", jp: "レモン" }, { en: "Orange", jp: "オレンジ" }, { en: "Green apple", jp: "青リンゴ" }, { en: "Red apple", jp: "赤リンゴ" }, { en: "Pear", jp: "洋梨" }, { en: "Peach", jp: "桃" }, { en: "Apricot", jp: "アプリコット" }, { en: "Cherry", jp: "チェリー" }, { en: "Banana", jp: "バナナ" }, { en: "Pineapple", jp: "パイナップル" }, { en: "Mango", jp: "マンゴー" } ],
      floral:  [ { en: "Lavender", jp: "ラベンダー" }, { en: "Rose", jp: "ローズ" }, { en: "Violet", jp: "スミレ" }, { en: "Orange blossom", jp: "オレンジブロッサム" }, { en: "Jasmine", jp: "ジャスミン" }, { en: "Chamomile", jp: "カモミール" }, { en: "Honeysuckle", jp: "ハニーサックル" }, { en: "Lilac", jp: "ライラック" }, { en: "Geranium", jp: "ゼラニウム" }, { en: "Peony", jp: "ピオニー" }, { en: "Osmanthus", jp: "金木犀" }, { en: "Lily", jp: "ユリ" } ],
      woody:   [ { en: "Oak", jp: "オーク" }, { en: "Cedar", jp: "シダー" }, { en: "Sandalwood", jp: "白檀" }, { en: "Cinnamon", jp: "シナモン" }, { en: "Nutmeg", jp: "ナツメグ" }, { en: "Clove", jp: "クローブ" }, { en: "Tobacco", jp: "タバコ" }, { en: "Leather", jp: "レザー" }, { en: "Toasted oak", jp: "トーストオーク" }, { en: "Charred wood", jp: "チャーウッド" }, { en: "Dry timber", jp: "乾燥材" }, { en: "Resin", jp: "樹脂" } ],
      smoky:   [ { en: "Smoke", jp: "スモーク" }, { en: "Bonfire", jp: "焚き火" }, { en: "Ash", jp: "灰" }, { en: "Seaweed", jp: "海藻" }, { en: "Rocky shore", jp: "岩場" }, { en: "Damp earth", jp: "湿った土" }, { en: "Char", jp: "炭" }, { en: "Tar", jp: "タール" }, { en: "Medicinal", jp: "メディシナル" }, { en: "Disinfectant", jp: "消毒液" }, { en: "Iodine", jp: "ヨード" }, { en: "Peat smoke", jp: "ピートスモーク" } ],
      sweet:   [ { en: "Cream", jp: "クリーム" }, { en: "Honey", jp: "ハチミツ" }, { en: "Custard", jp: "カスタード" }, { en: "Vanilla", jp: "バニラ" }, { en: "Caramel", jp: "キャラメル" }, { en: "Butterscotch", jp: "バタースコッチ" }, { en: "Toffee", jp: "トフィー" }, { en: "Maple syrup", jp: "メープルシロップ" }, { en: "Brown sugar", jp: "三温糖" }, { en: "Chocolate", jp: "チョコレート" }, { en: "Marzipan", jp: "マジパン" }, { en: "Molasses", jp: "モラセス" } ],
      winey:   [ { en: "Plum", jp: "プラム" }, { en: "Red wine", jp: "赤ワイン" }, { en: "Berry jam", jp: "ベリージャム" }, { en: "Fig", jp: "イチジク" }, { en: "Raisin", jp: "レーズン" }, { en: "Prune", jp: "プルーン" }, { en: "Sherry", jp: "シェリー" }, { en: "Port", jp: "ポート" }, { en: "Oloroso", jp: "オロロソ" }, { en: "Walnut", jp: "くるみ" }, { en: "Rancio", jp: "ランシオ" }, { en: "PX", jp: "PX" } ],
      cereal:  [ { en: "Wheat", jp: "小麦" }, { en: "Green grain", jp: "未熟穀物" }, { en: "Corn", jp: "トウモロコシ" }, { en: "Malt", jp: "モルト" }, { en: "Sweet malt", jp: "甘い麦汁" }, { en: "Oatmeal", jp: "オートミール" }, { en: "Bread", jp: "パン" }, { en: "Biscuit", jp: "ビスケット" }, { en: "Yeast", jp: "酵母" }, { en: "Toast", jp: "トースト" }, { en: "Grain porridge", jp: "麦粥" }, { en: "Rye", jp: "ライ麦" } ],
      sulfury: [ { en: "Metallic", jp: "メタリック" }, { en: "Onion", jp: "玉ねぎ" }, { en: "Garlic", jp: "ニンニク" }, { en: "Boiled cabbage", jp: "茹でたキャベツ" }, { en: "Boiled egg", jp: "茹で卵" }, { en: "Rubber", jp: "ゴム" }, { en: "Struck match", jp: "擦ったマッチ" }, { en: "Gunpowder", jp: "火薬" }, { en: "Sulfur", jp: "硫黄" }, { en: "Smoke taint", jp: "スモークテイント" }, { en: "Tanned leather", jp: "鞣し革" }, { en: "Burnt rubber", jp: "焦げたゴム" } ]
    };

    const catConfig = {
      fruity: { en: "FRUITY", jp: "フルーティー", hex: "#f4d03f" },
      floral: { en: "FLORAL", jp: "フローラル",   hex: "#ff99cc" },
      woody:  { en: "WOODY",  jp: "ウッディ",     hex: "#a67c52" },
      smoky:  { en: "SMOKY",  jp: "スモーキー",   hex: "#a0a0a0" },
      sweet:  { en: "SWEET",  jp: "スイート",     hex: "#f2a154" },
      winey:  { en: "WINEY",  jp: "ワイニー",     hex: "#e63946" },
      cereal: { en: "CEREAL", jp: "シリアル",     hex: "#d4a373" },
      sulfury:{ en: "SULFURY",jp: "サルファリー", hex: "#ccff00" }
    };

    const opacityLevels = [0, 0.3, 0.5, 0.7, 0.85, 1.0];
    let selectedScores = {};
    let myChart = null;
    let currentLang = 'en'; 
    let activeCategory = 'fruity';
    let historyStack = [];

    function hexToRgba(hex, alpha) {
      let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function setLang(lang) {
      currentLang = lang;
      document.getElementById('lang-en').classList.toggle('active', lang === 'en');
      document.getElementById('lang-jp').classList.toggle('active', lang === 'jp');
      updateUIText();
      renderTabs(); 
      renderCategoryHeader();
      renderButtons(activeCategory); 
      updateChart();
    }

    function updateUIText() {
      document.getElementById('emptyText').innerText = currentLang === 'en' ? 'Tap flavors below to build profile' : '下のボタンをタップして香りを記録してください';
      document.getElementById('text-undo').innerText = currentLang === 'en' ? 'Undo' : '戻る';
      document.getElementById('text-clear').innerText = currentLang === 'en' ? 'Clear' : 'クリア';
      document.getElementById('text-copy').innerText = currentLang === 'en' ? 'Copy Data' : 'コピー';
    }

    function renderTabs() {
      const tabContainer = document.getElementById('tabContainer');
      if(!tabContainer) return;
      tabContainer.innerHTML = '';
      for (const catKey in catConfig) {
        const tab = document.createElement('div');
        tab.className = `tab ${catKey === activeCategory ? 'active' : ''}`;
        tab.innerText = catConfig[catKey][currentLang];
        if (catKey === activeCategory) {
          tab.style.background = catConfig[catKey].hex;
          tab.style.color = '#111'; 
        }
        tab.onclick = () => { activeCategory = catKey; renderTabs(); renderCategoryHeader(); renderButtons(catKey); };
        tabContainer.appendChild(tab);
      }
    }

    function scrollTabs(direction) {
      const container = document.getElementById('tabContainer');
      const scrollAmount = 150;
      if (direction === 'left') {
        container.scrollLeft -= scrollAmount;
      } else {
        container.scrollLeft += scrollAmount;
      }
    }

    function renderCategoryHeader() {
      const config = catConfig[activeCategory];
      const header = document.getElementById('catHeader');
      document.getElementById('header-main').innerText = config.en;
      document.getElementById('header-sub').innerText = config.jp;
      header.style.background = config.hex;

      let count = 0;
      if(whiskyFlavorData[activeCategory]) {
        whiskyFlavorData[activeCategory].forEach(item => {
          if (selectedScores[`${activeCategory}_${item.en}`] > 0) count++;
        });
      }
      document.getElementById('header-count').innerText = currentLang === 'en' ? `${count} selected` : `${count} 選択`;
    }

    function renderButtons(catKey) {
      const btnGrid = document.getElementById('btnGrid');
      if(!btnGrid) return;
      btnGrid.innerHTML = ''; 
      const colorHex = catConfig[catKey].hex;
      
      if(whiskyFlavorData[catKey]) {
        whiskyFlavorData[catKey].forEach(item => {
          const dataId = `${catKey}_${item.en}`;
          const currentScore = selectedScores[dataId] || 0;
          
          const btn = document.createElement('div');
          btn.className = `card-btn ${currentScore > 0 ? 'selected' : ''}`;
          if (currentScore > 0) btn.style.borderColor = colorHex;
          
          const dots = currentScore === 0 ? "〇〇〇〇〇" : "●".repeat(currentScore) + "〇".repeat(5 - currentScore);
          const dotsColor = currentScore > 0 ? colorHex : '#ddd';

          const mainText = currentLang === 'en' ? item.en : item.jp;
          const subText  = currentLang === 'en' ? item.jp : item.en;
          
          btn.innerHTML = `
            <div class="card-main" style="color:${currentScore > 0 ? colorHex : 'var(--card-text)'}">${mainText}</div>
            <div class="card-sub">${subText}</div>
            <div class="card-dots" style="color:${dotsColor}">${dots}</div>
          `;
          
          btn.onclick = () => { 
            saveHistory();
            selectedScores[dataId] = ((selectedScores[dataId] || 0) + 1) % 6; 
            renderCategoryHeader(); 
            renderButtons(catKey); 
            updateChart(); 
          };
          btnGrid.appendChild(btn);
        });
      }
    }

    function saveHistory() {
      historyStack.push(JSON.parse(JSON.stringify(selectedScores)));
      if(historyStack.length > 50) historyStack.shift();
      updateUndoBtn();
    }

    function undo() {
      if(historyStack.length === 0) return;
      selectedScores = historyStack.pop();
      updateUndoBtn();
      renderCategoryHeader();
      renderButtons(activeCategory);
      updateChart();
    }

    function updateUndoBtn() {
      const btn = document.getElementById('undoBtn');
      if(historyStack.length > 0) {
        btn.style.opacity = '1';
        btn.style.pointerEvents = 'auto';
      } else {
        btn.style.opacity = '0.5';
        btn.style.pointerEvents = 'none';
      }
    }

    function saveImage() {
      if (!myChart) return;
      const url = myChart.getDataURL({ pixelRatio: 2, backgroundColor: '#000' });
      const link = document.createElement('a');
      link.download = 'AromaMosaic.png';
      link.href = url;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function updateChart() {
      const chartDom = document.getElementById('chart-container');
      const emptyOverlay = document.getElementById('emptyText');
      const chartData = [];
      let totalScore = 0;
      
      for (const catKey in catConfig) {
        const children = [];
        const baseColor = catConfig[catKey].hex;
        if(whiskyFlavorData[catKey]) {
          whiskyFlavorData[catKey].forEach(item => {
            const score = selectedScores[`${catKey}_${item.en}`] || 0;
            if (score > 0) {
              children.push({ name: item[currentLang], value: score, itemStyle: { color: hexToRgba(baseColor, opacityLevels[score]) } });
              totalScore += score;
            }
          });
          if (children.length > 0) chartData.push({ name: catConfig[catKey][currentLang], itemStyle: { color: baseColor }, children: children });
        }
      }

      if (totalScore === 0) {
        if (myChart) { myChart.dispose(); myChart = null; }
        emptyOverlay.style.display = 'flex';
        return;
      }
      emptyOverlay.style.display = 'none';

      if (!myChart) myChart = echarts.init(chartDom);
      const option = {
        toolbox: { show: false },
        tooltip: { formatter: '{b}: Level {c}' },
        series: [{
          type: 'treemap', 
          data: chartData, 
          roam: false, 
          nodeClick: false, 
          breadcrumb: { show: false },
          itemStyle: { borderColor: '#000', borderWidth: 2, gapWidth: 1 },
          // ▼▼▼ 修正: upperLabelを追加してカテゴリ名を表示 ▼▼▼
          upperLabel: {
            show: true,
            height: 20,
            color: '#fff',
            fontWeight: 'bold',
            fontSize: 11,
            textShadowColor: '#000',
            textShadowBlur: 2
          },
          label: { 
            show: true, 
            formatter: '{b}', 
            color: '#fff', 
            fontSize: 13, 
            fontWeight: 'bold', 
            textShadowColor: '#000', 
            textShadowBlur: 3 
          },
          left: 0, top: 0, right: 0, bottom: 0, width: '100%', height: '100%'
        }]
      };
      myChart.setOption(option);
    }

    function resetData() {
      if(confirm(currentLang === 'en' ? 'Clear all data?' : '入力データをすべて消去しますか？')) { 
        saveHistory();
        selectedScores = {}; 
        renderCategoryHeader();
        renderButtons(activeCategory); 
        updateChart(); 
      }
    }

    function copyData() {
      const date = new Date().toISOString().split('T')[0];
      let outputText = `Date: ${date}\n`;
      let hasData = false;
      for (const catKey in catConfig) {
        const flavors = [];
        if(whiskyFlavorData[catKey]) {
          whiskyFlavorData[catKey].forEach(item => {
            const score = selectedScores[`${catKey}_${item.en}`] || 0;
            if (score > 0) { flavors.push(`${item[currentLang]}(${score})`); hasData = true; }
          });
          if (flavors.length > 0) outputText += `${catConfig[catKey][currentLang]}: ${flavors.join(', ')}\n`;
        }
      }
      if(!hasData) return;
      navigator.clipboard.writeText(outputText).then(() => {
        const toast = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = currentLang === 'en' ? 'Copied!' : 'コピーしました';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      updateUIText();
      renderTabs();
      renderCategoryHeader();
      renderButtons(activeCategory);
    });
    window.addEventListener('resize', () => { if(myChart) myChart.resize(); });
  </script>
</body>
</html>